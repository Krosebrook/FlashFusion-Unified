name: Deploy to FlashFusion.co

on:
  push:
    branches: [ master ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
  
  pull_request:
    branches: [ master ]

  workflow_dispatch: # Allow manual trigger

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'  # Updated to Node 20 to fix Firecrawl compatibility
        cache: 'npm'
    
    - name: ğŸ”§ Install dependencies
      run: npm ci
      
    - name: ğŸ” Run deployment safety tests
      run: npm run test-deployment
      
    - name: ğŸ” Validate environment (non-blocking)
      run: npm run validate-keys || echo "âš ï¸ Some keys missing - continuing with deployment"
      
    - name: ğŸš€ Deploy to Vercel
      uses: amondnet/vercel-action@v25
      id: vercel-deploy
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod --confirm'
        working-directory: ./
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        
    - name: ğŸ¯ Get deployment URL
      run: |
        echo "DEPLOYMENT_URL=${{ steps.vercel-deploy.outputs.preview-url }}" >> $GITHUB_ENV
        echo "Deployed to: ${{ steps.vercel-deploy.outputs.preview-url }}"
        
    - name: â³ Wait for deployment
      run: sleep 30
      
    - name: ğŸ” Verify deployment health
      run: |
        echo "Testing deployment health..."
        curl -f "${{ steps.vercel-deploy.outputs.preview-url }}/health" || exit 1
        echo "âœ… Deployment health check passed!"
        
    - name: ğŸŒ Test custom domain (if configured)
      run: |
        echo "Testing custom domain..."
        curl -f "https://flashfusion.co/health" || echo "âš ï¸ Custom domain not yet configured"
        
    - name: ğŸ“ Create deployment summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Status:** Successful" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”— **URL:** ${{ steps.vercel-deploy.outputs.preview-url }}" >> $GITHUB_STEP_SUMMARY
        echo "ğŸŒ **Domain:** https://flashfusion.co" >> $GITHUB_STEP_SUMMARY
        echo "â° **Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“¦ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ‰ Notify success
      if: success()
      run: |
        echo "ğŸ‰ FlashFusion deployment successful!"
        echo "ğŸŒ Live at: ${{ steps.vercel-deploy.outputs.preview-url }}"
        echo "ğŸ·ï¸ Custom domain: https://flashfusion.co"
        
    - name: ğŸ’¥ Notify failure
      if: failure()
      run: |
        echo "âŒ FlashFusion deployment failed!"
        echo "ğŸ“‹ Check the logs above for details"
        exit 1

  # Optional: Create GitHub release on successful deployment
  create-release:
    needs: test-and-deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && success()
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Create release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: FlashFusion v${{ github.run_number }}
        body: |
          ğŸš€ **FlashFusion Deployment v${{ github.run_number }}**
          
          **Changes in this release:**
          - Automated deployment to https://flashfusion.co
          - Bulletproof logging system
          - Enhanced security features
          
          **Live URLs:**
          - ğŸŒ Main Site: https://flashfusion.co
          - ğŸ” Health Check: https://flashfusion.co/health
          - ğŸ“Š API Status: https://flashfusion.co/api/status
          
          **Deployment Details:**
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref_name }}
          - Time: ${{ github.event.head_commit.timestamp }}
        draft: false
        prerelease: false